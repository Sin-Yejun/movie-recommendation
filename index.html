<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Filmio - ì˜í™” ì¶”ì²œ í”Œë«í¼</title>
    <link rel="stylesheet" href="style.css" />
    <!-- í°íŠ¸: Pretendard & Google Fonts -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- ì•„ì´ì½˜: FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/12.2.0/markdown-it.min.js"></script>
    <script>
      async function sendMessage() {
        // ìƒëŒ€ ê²½ë¡œ ì‚¬ìš© (ë°°í¬/ë¡œì»¬ ëª¨ë‘ í˜¸í™˜)
        const url = "/chat";
        const message = document.getElementById("message").value;
        const responseContainer = document.getElementById("response");
        const recContainer = document.getElementById("recommendations"); // ì¶”ì²œ ì˜í™” ì»¨í…Œì´ë„ˆ

        if (!message) return;

        // ë²„íŠ¼ ë¹„í™œì„±í™” (ì¤‘ë³µ í´ë¦­ ë°©ì§€)
        const submitButton = document.getElementById("submit-button"); // Assuming an ID for the submit button
        submitButton.disabled = true;
        submitButton.style.opacity = "0.5";
        submitButton.style.cursor = "not-allowed";

        // ë¡œë”© í‘œì‹œ: ë‹µë³€ ì˜ì—­ì— í‘œì‹œ
        responseContainer.innerHTML = `
            <div style="text-align: center; color: #94a3b8; margin-top: 20px;">
                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 10px;"></i>
                <p>AIê°€ ë‹µë³€ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
            </div>
        `;
        recContainer.innerHTML = ""; // ì´ì „ ì¶”ì²œ ì´ˆê¸°í™”

        const md = window.markdownit();

        try {
            const response = await fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ input: message }),
            });

            if (!response.ok) throw new Error("Network response was not ok");

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let fullText = "";
            let isRecPart = false;
            let recJsonStr = "";

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value, { stream: true });
                fullText += chunk;

                // ì¶”ì²œ ë°ì´í„° êµ¬ë¶„ì í™•ì¸ (<<<REC>>>)
                const splitParts = fullText.split("<<<REC>>>");

                // 1. ë‹µë³€ ë¶€ë¶„ (Markdown ë Œë”ë§)
                const answerPart = splitParts[0];
                responseContainer.innerHTML = md.render(answerPart);

                // 2. ì¶”ì²œ ë°ì´í„° ë¶€ë¶„ (ì•„ì§ ì „ì†¡ ì¤‘ì¼ ìˆ˜ ìˆìŒ)
                if (splitParts.length > 1) {
                    recJsonStr = splitParts[1];
                }
            }

            // ìŠ¤íŠ¸ë¦¬ë° ì™„ë£Œ í›„ ì¶”ì²œ ì¹´ë“œ ì²˜ë¦¬
            if (recJsonStr.trim()) {
                try {
                    const recommendations = JSON.parse(recJsonStr.trim());
                    renderRecommendationCards(recommendations);
                } catch (e) {
                    console.error("ì¶”ì²œ ë°ì´í„° íŒŒì‹± ì‹¤íŒ¨:", e);
                }
            }

        } catch (error) {
            responseContainer.innerText = "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message;
        } finally {
            // ë²„íŠ¼ ì¬í™œì„±í™”
            submitButton.disabled = false;
            submitButton.style.opacity = "1";
            submitButton.style.cursor = "pointer";
            document.getElementById("message").value = ""; // ì…ë ¥ì°½ ë¹„ìš°ê¸°
        }
    }

    // ì¶”ì²œ ì¹´ë“œ ë Œë”ë§ í•¨ìˆ˜ ë¶„ë¦¬
    function renderRecommendationCards(titles) {
        const recContainer = document.getElementById("recommendations");
        recContainer.innerHTML = "";

        const recTitle = document.createElement("h3");
        recTitle.innerText = "âœ¨ ì¶”ì²œ ì˜í™” ë°”ë¡œë³´ê¸°";
        recTitle.style.marginTop = "20px";
        recTitle.style.textAlign = "left";
        recContainer.appendChild(recTitle);

        const cardWrapper = document.createElement("div");
        cardWrapper.className = "rec-wrapper";
        recContainer.appendChild(cardWrapper);


        titles.forEach(title => {
             // ì˜í™” ì œëª©ìœ¼ë¡œ ì •ë³´ ì°¾ê¸° (allMovies ë°°ì—´ í™œìš©)
             const movieInfo = allMovies.find(m => m.ì œëª©.includes(title)) || { ì œëª©: title, ì˜í™”í¬ìŠ¤í„°: null };
             const poster = movieInfo.ì˜í™”í¬ìŠ¤í„° || "https://via.placeholder.com/150x220?text=No+Image";
             const rating = movieInfo["ê´€ëŒê° í‰ì "] || "N/A";
             const audience = movieInfo["ê´€ê°ìˆ˜"] || "";

             const card = document.createElement("div");
             card.className = "rec-card";
             card.innerHTML = `
                <div class="poster-wrapper"><img src="${poster}"></div>
                <div class="card-info">
                    <h4>${movieInfo.ì œëª©}</h4>
                    <div class="rating"><i class="fas fa-star"></i> ${rating}</div>
                    <div class="audience">${audience}</div>
                </div>
             `;
             card.onclick = () => {
                 const input = document.getElementById("message");
                 input.value = `ì˜í™” "${movieInfo.ì œëª©}" ìƒì„¸ ì •ë³´ ì•Œë ¤ì¤˜`;
                 input.focus();
             };
             cardWrapper.appendChild(card);
        });
    }

      async function loadMovies() {
        try {
          const response = await fetch("src/db/movies.json");
          const movies = await response.json();

          const gallery = document.querySelector(".image-gallery");
          gallery.innerHTML = "";

          movies.forEach((movie, index) => {
            const movieItem = document.createElement("div");
            movieItem.classList.add("image-item");
            if (index >= 4) movieItem.style.display = "none";

            movieItem.innerHTML = `
                        <img src="${movie.ì˜í™”í¬ìŠ¤í„°}" alt="${movie.ì œëª©}" onclick="setMovieQuery('${movie.ì œëª©}')">
                        <p>${movie.ì œëª©}</p>
                    `;
            gallery.appendChild(movieItem);
          });
          showSlides(0);
        } catch (error) {
          console.error("Error loading movies:", error);
        }
      }

      function setMovieQuery(title) {
        document.getElementById(
          "message"
        ).value = `${title} ì˜í™”ì— ëŒ€í•œ ì •ë³´ ì•Œë ¤ì¤˜.`;
      }

      let currentIndex = 0;
      function showSlides(index) {
        const slides = document.querySelectorAll(".image-item");
        const totalSlides = slides.length;
        const itemsToShow = 4;

        if (index >= totalSlides) {
          currentIndex = 0;
        } else if (index < 0) {
          currentIndex = totalSlides - itemsToShow;
        } else {
          currentIndex = index;
        }

        slides.forEach((slide, i) => {
          slide.style.display =
            i >= currentIndex && i < currentIndex + itemsToShow
              ? "block"
              : "none";
        });
      }

      function nextSlides() {
        showSlides(currentIndex + 4);
      }

      function prevSlides() {
        showSlides(currentIndex - 4);
      }

      // date.txt íŒŒì¼ì„ ë¶ˆëŸ¬ì™€ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
      async function loadDate() {
        try {
          const response = await fetch("src/db/date.txt");
          if (!response.ok) {
            throw new Error("date.txt íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
          }
          const dateText = await response.text();
          document.getElementById("date-display").textContent = dateText;
        } catch (error) {
          console.error("Error loading date:", error);
          document.getElementById("date-display").textContent =
            "ì—…ë°ì´íŠ¸ ë‚ ì§œë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        loadMovies();
        loadDate();
      });

      let loadingInterval;

      function startLoadingAnimation() {
        const loadingText = document.getElementById("loading-text");
        let dotCount = 0;
        loadingText.textContent = "ë‹µë³€ ìƒì„± ì¤‘";

        loadingInterval = setInterval(() => {
          dotCount = (dotCount + 1) % 4; // 0~3ê¹Œì§€ ë°˜ë³µ
          let dots = ".".repeat(dotCount);
          loadingText.textContent = "ë‹µë³€ ìƒì„± ì¤‘" + dots;
        }, 500); // 0.5ì´ˆë§ˆë‹¤ ê°±ì‹ 
      }

      function stopLoadingAnimation() {
        clearInterval(loadingInterval);
        const loadingText = document.getElementById("loading-text");
        if (loadingText) {
          loadingText.textContent = "";
        }
      }
    </script>
  </head>

  <body>
    <header>
      <div id="date-display">ë‚ ì§œ ë¡œë“œ ì¤‘...</div>
      <h1>Filmio</h1>
      <div class="cinema-links">
        <a href="https://cgv.co.kr/" target="_blank"
          ><img src="src/img/cgv_logo.png" alt="CGV"
        /></a>
        <a href="https://www.lottecinema.co.kr/NLCHS?referrer=https://www.google.com/" target="_blank"
          ><img src="src/img/lotte_logo.png" alt="ë¡¯ë°ì‹œë„¤ë§ˆ"
        /></a>
        <a href="https://www.megabox.co.kr/" target="_blank"
          ><img src="src/img/megabox_logo.png" alt="ë©”ê°€ë°•ìŠ¤"
        /></a>
      </div>
    </header>

    <div class="main-layout">
        <!-- [LEFT] Side Panel: Movies & Stats -->
        <aside class="side-panel">
            <section class="info-container">
                <h1>Filmio <span style="font-size: 1rem; color: var(--primary-color);">AI</span></h1>
                <p class="subtitle">
                    AIê°€ ìµœì‹  <strong><span id="stat-movies">0</span>í¸</strong>ì˜ ì˜í™”ì™€ 
                    <strong><span id="stat-reviews">0</span>ê°œ</strong>ì˜ ì‹¤ê´€ëŒê° ë¦¬ë·°ë¥¼ ë¶„ì„í•´ë“œë¦½ë‹ˆë‹¤.
                </p>
            </section>

            <!-- Slider Moved Here -->
            <section class="slider-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h2 style="font-size: 1.2rem; margin: 0;">ğŸ”¥ ìš”ì¦˜ ëœ¨ëŠ” ì˜í™”</h2>
                    <!-- Slider controls removed -->
                </div>
                <div class="slider-content">
                    <div class="image-gallery" id="image-gallery">
                        <div style="color: grey; padding: 20px;">ë¡œë”© ì¤‘...</div>
                    </div>
                </div>
                <!-- ... -->

    <script>
        // ... (sendMessage function) ...

        let allMovies = [];

        // ì˜í™” ë°ì´í„° ë¡œë“œ ë° ê·¸ë¦¬ë“œ ë Œë”ë§
        async function loadMovies() {
            try {
                const response = await fetch("src/db/movies.json");
                if (!response.ok) throw new Error("Failed to load movies.json");
                
                allMovies = await response.json();
                renderMovies(allMovies);
            } catch (error) {
                console.error("ì˜í™” ë¡œë”© ì‹¤íŒ¨:", error);
                document.getElementById("image-gallery").innerHTML = "ì˜í™” ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
            }
        }

        function renderMovies(movies) {
            const gallery = document.getElementById("image-gallery");
            gallery.innerHTML = "";

            movies.forEach((movie) => {
                // ì´ë¯¸ì§€ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì²˜ë¦¬ (í•„ìš”ì‹œ)
                const posterUrl = movie.ì˜í™”í¬ìŠ¤í„° || "https://via.placeholder.com/200x300?text=No+Image";

                const div = document.createElement("div");
                div.className = "image-item";
                div.onclick = () => {
                    const input = document.getElementById("message");
                    input.value = `ì˜í™” "${movie.ì œëª©}"ì˜ ì¤„ê±°ë¦¬ì™€ ê´€ëŒí‰ ì•Œë ¤ì¤˜`;
                    input.focus();
                };

                div.innerHTML = `
                    <img src="${posterUrl}" alt="${movie.ì œëª©}" onerror="this.src='https://via.placeholder.com/200x300?text=No+Image'"/>
                    <p>${movie.ì œëª©}</p>
                `;
                gallery.appendChild(div);
            });
        }
        
        // ì´ˆê¸° ë¡œë“œ
        loadMovies();
        // ... (fetchStats logic) ...
    </script>
        </aside>

        <!-- [RIGHT] Chat Panel -->
        <main class="chat-panel">
            <div class="chat-header">
                <h2>AI ì˜í™” íë ˆì´í„°</h2>
                <p>ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”. ì¤„ê±°ë¦¬, ë¦¬ë·°, ë°°ìš° ì •ë³´ê¹Œì§€ ì•Œë ¤ë“œë ¤ìš”.</p>
            </div>

            <div class="chat-window">
                 <div class="response-container">
                    <div id="response">
                        <div class="empty-state">
                            <i class="fas fa-film" style="font-size: 3rem; margin-bottom: 1rem; color: #334155;"></i>
                            <p>ê¶ê¸ˆí•œ ì˜í™”ë‚˜ ì¥ë¥´ë¥¼ ë¬¼ì–´ë³´ì„¸ìš”!<br>"ë°˜ì „ ìˆëŠ” ìŠ¤ë¦´ëŸ¬ ì¶”ì²œí•´ì¤˜"</p>
                        </div>
                    </div>
                    <!-- Recommendations will be injected here via JS -->
                    <div id="recommendations" class="rec-wrapper"></div>
                </div>
            </div>

            <form onsubmit="event.preventDefault(); sendMessage();" class="input-area">
                <input
                    type="text"
                    id="message"
                    name="message"
                    placeholder="ex. ì›¡ì¹´ í‰ì  ì–´ë•Œ? / ê°€ì¡±ì´ë‘ ë³¼ë§Œí•œ ì˜í™” ì¶”ì²œ"
                    required
                    autocomplete="off"
                />
                <button type="submit" id="submit-button"><i class="fas fa-paper-plane"></i></button>
            </form>
        </main>
    </div>

    <!-- Script Logic Updates -->
    <script>
        // í†µê³„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (API Call)
        async function fetchStats() {
            try {
                const url = "/stats";
                const response = await fetch(url);
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById("stat-movies").innerText = data.movie_count.toLocaleString();
                    document.getElementById("stat-reviews").innerText = data.review_count.toLocaleString();
                }
            } catch (error) {
                console.error("í†µê³„ ë¡œë“œ ì‹¤íŒ¨:", error);
            }
        }
        fetchStats();
    </script>
  </body>
</html>
