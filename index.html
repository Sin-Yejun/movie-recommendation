<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filmio - ì˜í™” ì¶”ì²œ í”Œë«í¼</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/12.2.0/markdown-it.min.js"></script>
    <script>
        async function sendMessage() {

            const url = "https://movie-recommendation-production.up.railway.app/chat";
            //const url = "http://127.0.0.1:8000/chat";
            const message = document.getElementById("message").value;
            const responseContainer = document.getElementById("response");
            const submitButton = document.getElementById("submit-button");

            submitButton.disabled = true; // ë²„íŠ¼ ë¹„í™œì„±í™”
            submitButton.style.opacity = "0.5"; // ë²„íŠ¼ íë¦¬ê²Œ
            submitButton.innerText = "ìƒì„± ì¤‘...";
            responseContainer.innerHTML = '<span id="loading-text" style="font-style: italic; color: gray;"></span>';
            startLoadingAnimation(); // ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
            const md = window.markdownit();
            try {
                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ query: message })
                });

                if (!response.body) throw new Error("ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ ì—†ìŒ");

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let partial = "";

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    stopLoadingAnimation(); // ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ì¤‘ì§€
                    const chunk = decoder.decode(value, { stream: true });
                    partial += chunk;

                    // Markdownì„ HTMLë¡œ ë³€í™˜í•˜ì—¬ ì¶œë ¥
                    responseContainer.innerHTML = md.render(partial);
                }
            } catch (error) {
                console.error("Error:", error);
                responseContainer.innerHTML = "Error: ì‘ë‹µì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
            } finally {
                submitButton.disabled = false; // ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
                submitButton.style.opacity = "1";
                submitButton.innerText = "ğŸ¥ ë‹µë³€ ìƒì„±";
            }
        }

        async function loadMovies() {
            try {
                const response = await fetch('src/db/movies.json');
                const movies = await response.json();

                const gallery = document.querySelector('.image-gallery');
                gallery.innerHTML = '';

                movies.forEach((movie, index) => {
                    const movieItem = document.createElement('div');
                    movieItem.classList.add('image-item');
                    if (index >= 4) movieItem.style.display = "none";

                    movieItem.innerHTML = `
                        <img src="${movie.ì˜í™”í¬ìŠ¤í„°}" alt="${movie.ì œëª©}" onclick="setMovieQuery('${movie.ì œëª©}')">
                        <p>${movie.ì œëª©}</p>
                    `;
                    gallery.appendChild(movieItem);
                });
                showSlides(0);
            } catch (error) {
                console.error("Error loading movies:", error);
            }
        }

        function setMovieQuery(title) {
            document.getElementById("message").value = `${title} ì˜í™”ì— ëŒ€í•œ ì •ë³´ ì•Œë ¤ì¤˜.`;
        }

        let currentIndex = 0;
        function showSlides(index) {
            const slides = document.querySelectorAll('.image-item');
            const totalSlides = slides.length;
            const itemsToShow = 4;

            if (index >= totalSlides) {
                currentIndex = 0;
            } else if (index < 0) {
                currentIndex = totalSlides - itemsToShow;
            } else {
                currentIndex = index;
            }

            slides.forEach((slide, i) => {
                slide.style.display = (i >= currentIndex && i < currentIndex + itemsToShow) ? 'block' : 'none';
            });
        }

        function nextSlides() {
            showSlides(currentIndex + 4);
        }

        function prevSlides() {
            showSlides(currentIndex - 4);
        }

        // date.txt íŒŒì¼ì„ ë¶ˆëŸ¬ì™€ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
        async function loadDate() {
            try {
                const response = await fetch('src/db/date.txt');
                if (!response.ok) {
                    throw new Error("date.txt íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                }
                const dateText = await response.text();
                document.getElementById("date-display").textContent = dateText;
            } catch (error) {
                console.error("Error loading date:", error);
                document.getElementById("date-display").textContent = "ì—…ë°ì´íŠ¸ ë‚ ì§œë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadMovies();
            loadDate();
        });

        let loadingInterval;

        function startLoadingAnimation() {
            const loadingText = document.getElementById("loading-text");
            let dotCount = 0;
            loadingText.textContent = "ë‹µë³€ ìƒì„± ì¤‘";

            loadingInterval = setInterval(() => {
                dotCount = (dotCount + 1) % 4; // 0~3ê¹Œì§€ ë°˜ë³µ
                let dots = '.'.repeat(dotCount);
                loadingText.textContent = "ë‹µë³€ ìƒì„± ì¤‘" + dots;
            }, 500); // 0.5ì´ˆë§ˆë‹¤ ê°±ì‹ 
        }

        function stopLoadingAnimation() {
            clearInterval(loadingInterval);
            const loadingText = document.getElementById("loading-text");
            if (loadingText) {
                loadingText.textContent = "";
            }
        }

    </script>
</head>

<body>
    <header>
        <div id="date-display">ë‚ ì§œ ë¡œë“œ ì¤‘...</div>
        <h1>Filmio</h1>
        <div class="cinema-links">
            <a href="https://www.cgv.co.kr/" target="_blank"><img src="src/img/cgv_logo.png" alt="CGV"></a>
            <a href="https://www.lottecinema.co.kr/" target="_blank"><img src="src/img/lotte_logo.png" alt="ë¡¯ë°ì‹œë„¤ë§ˆ"></a>
            <a href="https://www.megabox.co.kr/" target="_blank"><img src="src/img/megabox_logo.png" alt="ë©”ê°€ë°•ìŠ¤"></a>
        </div>
    </header>

    <section class="info-container">
        <h2>ğŸ¬ ì˜í™” ì¶”ì²œ AI</h2>
        <p>
            ê¶ê¸ˆí•œ ì˜í™”ë¥¼ ì…ë ¥í•˜ë©´ AIê°€ <strong>ì¤„ê±°ë¦¬, ë¦¬ë·°, ì¶œì—°ì§„</strong> ì •ë³´ë¥¼ ì•Œë ¤ë“œë ¤ìš”.<br>
            ì˜ˆ: <em>"ìš”ì¦˜ ì–´ë–¤ ì˜í™”ê°€ ì¬ë°Œì–´?"</em>, <em>"ì•¡ì…˜ ì˜í™” ì¶”ì²œí•´ì¤˜"</em>
        </p>
        <p style="margin-top: 0.5em;">
            ğŸï¸ ì•„ë˜ í¬ìŠ¤í„°ë¥¼ í´ë¦­í•˜ë©´ <strong>í•´ë‹¹ ì˜í™” ì§ˆë¬¸ì´ ìë™ ì…ë ¥</strong>ë¼ìš”!
        </p>
        
    </section>

    <form onsubmit="event.preventDefault(); sendMessage();">
        <input type="text" id="message" name="message" placeholder="ì˜í™” ì¶”ì²œ, ì¤„ê±°ë¦¬, ë¦¬ë·°, ë°°ìš° ì •ë³´ ë“± ë¬´ì—‡ì´ë“  ì§ˆë¬¸í•˜ì„¸ìš”!
        ." required>
        <button type="submit" id="submit-button">ğŸ¥ ë‹µë³€ ìƒì„±</button>
    </form>

    <section class="response-container">
        <h2>ë‹µë³€</h2>
        <div id="response"></div>
    </section>

    <section class="slider-container">
        <h2>í˜„ì¬ ìƒì˜ ì¤‘ì¸ ì˜í™”</h2>
        <div class="slider-content">
            <button class="slider-button" onclick="prevSlides()">&#10094;</button>
            <div class="image-gallery"></div>
            <button class="slider-button" onclick="nextSlides()">&#10095;</button>
        </div>
    </section>
</body>

</html>